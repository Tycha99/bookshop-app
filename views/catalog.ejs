<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Каталог — BookShop</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body data-role="<%= user ? user.role : '' %>">
<%- include('partials/header') %>

<main class="container">
    <h1>Каталог книг</h1>

    <% if (user && (user.role === 'seller' || user.role === 'admin')) { %>
        <p><a href="/books/add" class="btn">Добавить книгу</a></p>
    <% } %>

    <div class="search-bar">
        <input type="text" id="search" placeholder="Поиск книг...">
    </div>

    <div class="book-grid">
        <% books.forEach(function(b) { %>
            <div class="book-card">
                <!-- Здесь можно вставить реальный путь к обложке -->
                <img src="/images/default-book.jpg" alt="<%= b.title %>">
                <div class="book-info">
                    <h3><%= b.title %></h3>
                    <div class="author"><%= b.author %></div>
                    <div class="price"><%= b.price %> ₽</div>
                    <div class="actions">
                        <% if (user && user.role === 'buyer') { %>
                            <button class="add-btn" data-id="<%= b.id %>">В корзину</button>
                        <% } %>
                        <% if (user && (user.role === 'seller' || user.role === 'admin')) { %>
                            <form action="/books/delete/<%= b.id %>" method="post" style="display:inline;">
                                <button type="submit">Удалить</button>
                            </form>
                        <% } %>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>
</main>

<div class="success-flash" id="success-flash">Книга добавлена в корзину!</div>

<script>
    $(function(){
        var role = $('body').data('role');
        var isBuyer = (role === 'buyer');

        // AJAX-поиск
        $('#search').on('input', function() {
            var q = $(this).val();
            $.get('/books/search', { q: q }, function(list) {
                var html = '';
                if (list.length) {
                    for (var i = 0; i < list.length; i++) {
                        var b = list[i];
                        html += '<div class="book-card">'
                            +   '<img src="/images/default-book.jpg" alt="' + b.title + '">'
                            +   '<div class="book-info">'
                            +     '<h3>' + b.title + '</h3>'
                            +     '<div class="author">' + b.author + '</div>'
                            +     '<div class="price">' + b.price + ' ₽</div>'
                            +     '<div class="actions">';
                        if (isBuyer) {
                            html += '<button class="add-btn" data-id="' + b.id + '">В корзину</button>';
                        }
                        html +=       '</div>'
                            +   '</div>'
                            + '</div>';
                    }
                } else {
                    html = '<p>Ничего не найдено</p>';
                }
                $('.book-grid').html(html);
            });
        });

        // AJAX добавление в корзину
        $('body').on('click', '.add-btn', function() {
            var btn = $(this);
            $.post('/cart/add', { bookId: btn.data('id') }, function(){
                $('#success-flash').fadeIn(200).delay(1000).fadeOut(400);
            });
        });
    });
</script>
</body>
</html>
